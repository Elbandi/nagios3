#! /bin/sh /usr/share/dpatch/dpatch-run
# Description: fix cross-site scripting in layer url
# Origin: other, http://www.rul3z.de/advisories/SSCHADV2011-002.txt
# Bug: http://tracker.nagios.org/view.php?id=207
# Bug-Debian: http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=629127

@DPATCH@
diff -urNad '--exclude=CVS' '--exclude=.svn' '--exclude=.git' '--exclude=.arch' '--exclude=.hg' '--exclude=_darcs' '--exclude=.bzr' nagios3-3.2.0~/cgi/statusmap.c nagios3-3.2.0/cgi/statusmap.c
--- nagios3-3.2.0~/cgi/statusmap.c	2009-07-07 18:19:45.000000000 -0400
+++ nagios3-3.2.0/cgi/statusmap.c	2011-06-01 15:10:45.684532214 -0400
@@ -2404,7 +2404,7 @@
 
 	for(temp_layer=layer_list;temp_layer!=NULL;temp_layer=temp_layer->next){
 		if(get_method==TRUE)
-			printf("&layer=%s",temp_layer->layer_name);
+			printf("&layer=%s",escape_string(temp_layer->layer_name));
 		else
 			printf("<input type='hidden' name='layer' value='%s'>\n",escape_string(temp_layer->layer_name));
 	        }
